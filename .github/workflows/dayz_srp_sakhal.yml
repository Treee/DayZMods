name: DayZ SRP Sakhal Mods

on:
  push:
    branches:
      - release

jobs:
  dayz_srp_sakhal:
    name: Pack release pbos
    runs-on: windows-latest
    steps:
      - name: Setup SteamCMD
        id: steamcmd
        uses: CyberAndrii/setup-steamcmd@v1

      - name: Install DayZ & DayZ Tools
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
        run: |
          steamcmd +login "$env:STEAM_USERNAME" "$env:STEAM_PASSWORD" +app_update 830640 +app_update 221100 validate +quit

      - name: Debug
        run: |
          echo "output ${{steps.steamcmd.outputs.directory}}"

      - name: Install Wardog DayZ 2 P
        uses: robinraju/release-downloader@v1
        with:
          repository: wrdg/DayZExtract
          fileName: "*-portable.zip"
          out-file-path: DayZExtract
          latest: true
          zipBall: true
          tarBall: false
          extract: true

      - name: Extract Portable Tools
        run: |
          cd ${{ github.workspace }}\DayZExtract
          7z x DayZExtract-*-portable.zip -y -o .
          DayZExtract.exe P:\ -p 10 -u

      - name: Install Mikero Tools
        uses: arma-actions/mikero-tools@latest

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source

      - name: Make mod folders
        run: |
          cd ${{ github.workspace }}
          mkdir mods
          echo ${{ github.workspace }}\source
          echo ${{ github.workspace }}\mods

      - name: Pack Project With PboProject
        run: |
          Get-Command pboproject
          pboProject ${{ github.workspace }}\source +M=${{ github.workspace }}\mods

      - name: Validate Packing
        run: |
          pwd
          cd ${{ github.workspace }}\mods
          pwd
          dir
